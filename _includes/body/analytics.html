{% if site.google_analytics %}
<script>!function (w, d) {
        /* w.ga = w.ga || function () {
                  (ga.q = ga.q || []).push(arguments);
                  console.log('gaq', ga.q, arguments);
              }; ga.l = +new Date; */


        window.dataLayer = w.dataLayer || [];
        function gtag() {dataLayer.push(arguments);}
        console.log(dataLayer);

        /* w.gtag = w.gtag || function gtag() {dataLayer.push(arguments);}  */

        gtag('js', new Date());

        function gtagConsentDefaultOff() {
            gtag('consent', 'default', {
                'ad_storage': 'denied',
                'analytics_storage': 'denied'
            });
        };

        function gtagConsentUpdateOn() {
            gtag('consent', 'update', {
                'ad_storage': 'granted',
                'analytics_storage': 'granted'
            });
        };

        /*{% if site.hydejack.cookies_banner %}*/
        if (navigator.CookiesOK) {
            /*  CookiesOK is not part of the navigator spec, not sure when this is true (extensions?) */
            /*  noop */
            /*  ga('create', '{{ site.google_analytics }}', 'auto'); */
        } else if (d.cookie.indexOf("hy--cookies-ok=true") > -1) {
            /* if cookies are opt-in only and opted for */
            gtagConsentUpdateOn();

            /*
            gtag('config', '{{ site.google_analytics }}');
            ga('create', '{{ site.google_analytics }}', {
                'storage': 'none',
                'client_id': localStorage ? localStorage.getItem('ga--client-id') : undefined
            });
            */
        } else {
            /* consent required and not yet given */
            gtagConsentDefaultOff();
            /*
            ga('create', '{{ site.google_analytics }}', {
                'storage': 'none'
            });
            ga('set', 'forceSSL', true);
            ga('set', 'anonymizeIp', true);
            */
        }

        /*{% endif %}*/
        gtag('config', '{{ site.google_analytics }}');

        /* GA4 can handle history API on its own
         configures this in the GA control panel as part of Enhanced measurement
         */
        /* var pushStateEl = d.getElementById('_pushState');
        var timeoutId;
        pushStateEl.addEventListener('hy-push-state-load', function () {
            w.clearTimeout(timeoutId);
            timeoutId = w.setTimeout(function () {
                ga('set', 'page', w.location.pathname);
                ga('send', 'pageview');
            }, 500);
            });*/

        d.addEventListener('hy--cookies-ok', function () {
            gtagConsentUpdateOn();
            /*
              w.ga(function (tracker) {
                w.ga("set", "anonymizeIp", undefined);
                localStorage && localStorage.setItem("ga--client-id", tracker.get("client_id"));
              });
            */
        });

        w.loadJSDeferred('https://www.googletagmanager.com/gtag/js?id={{ site.google_analytics }}');
    }(window, document);</script>
{% endif %}
